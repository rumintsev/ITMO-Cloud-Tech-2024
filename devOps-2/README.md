# Лабораторная работа 2
### Задачи:

1. Написать “плохой” Dockerfile, в котором есть не менее трех “bad practices” по написанию докерфайлов
2. Написать “хороший” Dockerfile, в котором эти плохие практики исправлены
3. В Readme описать каждую из плохих практик в плохом докерфайле, почему она плохая и как в хорошем она была исправлена, как исправление повлияло на результат
4. В Readme описать 2 плохих практики по работе с контейнерами. ! Не по написанию докерфайлов, а о том, как даже используя хороший докерфайл можно накосячить именно в работе с контейнерами.

### Ход работы:

## 3 плохие практики по написанию dockerFile
Сразу напишем плохой dockerfile, а в комментариях к коду, в чём заключается эта плохая практика
```dockerfile
# 1. Используем тяжелый образ Ubuntu и latest-тег
FROM ubuntu:latest  

# 2. Устанавливаем пакеты, не фиксируя версии и не удаляя лишний кэш
RUN apt-get update && apt-get install -y \
    curl \
    git

# 3. Жёстко встраиваем секреты в образ
ENV API_KEY="super_secret_key"
```

Далее напишем хороший dockerfile, а в комментариях к коду, как была решена плохая практика
```dockerfile
# 1. Используем легковесный базовый образ Alpine с указанной версией
FROM python:3.9-alpine

# 2. Устанавливаем пакеты с no-cache и явно указываем версии
RUN apk add --no-cache --update \
    curl=8.11.0-r2 \
    git=2.45.2-r0
```
```bash
# 3. Используем внешние переменные окружения для секретов, например при запуске
docker run -e API_KEY="super_secret_key" myapp
```
**Комментарий к 1 практике:**

Большие образы, такие как ubuntu, увеличивают время загрузки и использование ресурсов (Alpine ~5 МБ, Ubuntu 29–40 МБ), поэтому для неспецифических задач используем Alpine. А указание версии позволяет всё делать на стабильной версии.

**Комментарий к 2 практике:**

Если мы не указываем версию явно это может привести к траблам при сборке или запуске, но нужно быть аккуратным, так как в старых версиях потенциально могут быть уязвимости. --no-cache же позволяет не захламлять хранилище лишним кэшэм.

**Комментарий к 3 практике:**

Если добавлять секрет прямо в Dockerfile мы рискуем, что он утечёт при разных ситуациях, чтобы такого точно не случилось и чтобы лишний раз об этом не думать лучше передавать их контейнеру на этапе запуска, а не сборки.

**Альтернативное решение к 1 плохой практике:**

Использовать стабильную версию Ubuntu вместо latest (`FROM ubuntu:20.04`), так мы будем собирать контейнеры на стабильной версии

**Альтернативное решение к 2 плохой практике:**

Если вам нужны библиотеки, которые отсутствуют в Alpine можно использовать apt-get clean и удалять `lists`, плюс не забываем про указание версии
```dockerfile
RUN apt-get update && \
    apt-get install -y \
        curl=7.68.0-1ubuntu2.12 \
        git=1:2.25.1-1ubuntu3.10 && \
    apt-get clean && rm -rf /var/lib/apt/lists/*
```
## 2 плохие практики по работе с контейнерами

**1. Запуск контейнера без ограничений по CPU и памяти:**

Если контейнер написан неправильно или случилось что-то непредвиденное, один контейнер может занять всю оперативную память или процессорное время, что приведёт к неприятному исходу.

Для предотвращения таких неприятных вещей, при запуске ограничиваем контейнер в ресурсах
```bash
docker run --memory=512m --cpus="1.5" your_image
```

**2. Запуск контейнеров с правами root:**

При запуске от имени root может произойти выход за пределы контейнера или могут быть выполнены неприятные операции с файловой системой, сетью и всяким таким.

Для предотвращения таких неприятных вещей, при запуске выбираем юзера, не имеющего административных прав
```bash
docker run --user 1000:1000 -it your_image
```
## Соберём образы и посмотрим

Создадим два докерфайла вставим в них наши хорошие и плохие практики

![Снимок экрана 2024-11-27 155624](https://github.com/user-attachments/assets/180868d1-4e22-4f45-9b25-d774e4014115)

![Снимок экрана 2024-11-27 155406](https://github.com/user-attachments/assets/d0f718b3-e89f-4d4c-94ee-4eff42a401d1)

Для определения актуальных версий для хорошего докерфайла можно воспользоваться 
```bash
docker run -it python:3.9-alpine sh`
```
```sh
apk update
apk search curl
apk search git

```

Билдим оба образа

![Снимок экрана 2024-11-27 155753](https://github.com/user-attachments/assets/a23f9354-51fa-4829-bf79-ad235f341513)

![Снимок экрана 2024-11-27 155831](https://github.com/user-attachments/assets/b06a4aee-c86e-4278-a592-2db887f053eb)

Помимо повышения безопасности хорошего докерфайла отметим и существенное уменьшение размера хорошего образа, чего мы и хотели добиться

![Снимок экрана 2024-11-27 155903](https://github.com/user-attachments/assets/8947e08a-f081-4781-9afb-d40660f6cfce)
